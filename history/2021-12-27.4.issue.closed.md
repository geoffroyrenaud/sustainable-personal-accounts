# [\#4 Issue](https://github.com/reply-fr/sustainable-personal-accounts/issues/4) `closed`: Prepare Automation AWS account

#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) opened issue at [2021-12-27 22:17](https://github.com/reply-fr/sustainable-personal-accounts/issues/4):

The Automation AWS account is hosting all central computing and storage resources used for SPA. The EventBridge bus used by SPA is the default bus of the Automation AWS account itself. 

- [x] Grant permissions to allow events from other AWS accounts. While the bus does not need to be created, there is a need to [configure it for cross-account event submission](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-cross-account.html). This has to be done once.

- [x] Create a CloudWatch log group to reflect events generated by AWS Organizations. After authentication to Automation account, go to Ireland region and create a CloudWatch log group. Select name `/aws/events/aws-organizations-events` and retention period of 30 days.

- [x] #9

- [x] Test the manual deployment by moving an account from one OU to another OU, and then move it back to the original OU. This should generate two events visible in CloudWatch logs. Copy these events and put each of them in a `.json` file in the folder `/tests/events` of this git repository.

- [ ] Delete the CloudWatch log group and the EventBridge rule that were created manually.

- [ ] Create python code with CDK to automate the creation of CloudWatch log group and EventBridge. Script should be named `deploy_resources.py` and be placed in the root directory of this repository.

- [ ] Run python code and deploy resources in Automation account.

- [ ] Test the automated deployment by moving an account from one OU to another OU, and then move it back to the original OU. This should generate two events visible in CloudWatch logs. 

- NB : Tag all manually created ressources with : "Stack:sustainable-personal-accounts" . BGA


#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) commented at [2021-12-29 08:46](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1002463905):

There is also a need to add a policy in Automation account that allows to assume ServiceRoleForAutomation in management account. This policy has to be attached to EC2 instance role and to Lambda execution role afterwards.

- [x] Create policy AssumeServiceRoleForAutomation in IAM of Automation account with following policy

```json
{
    "Version": "2012-10-17",
    "Statement": {
        "Effect": "Allow",
        "Action": "sts:AssumeRole",
        "Resource": "arn:aws:iam::396045030202:role/ServiceRoleForAutomation"
    }
}
```

#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) commented at [2021-12-29 09:02](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1002469951):

In boto3, the move of an AWS account from one OU to another one is a single line of code. However, the operation is allowed only after a specific role has been assumed. Below some tentative code, that has not been tested, that materializes the way of working:

```python
import boto3

ROLE_ARN = 'arn:aws:iam::396045030202:role/ServiceRoleForAutomation'

def lambda_handler(event, context):

    session = boto3.client('sts').assume_role(RoleArn=ROLE_ARN, RoleSessionName="lambda_automation")

    credentials = dict(
        aws_access_key_id=session['Credentials']['AccessKeyId'],
        aws_secret_access_key=session['Credentials']['SecretAccessKey'],
        aws_session_token=session['Credentials']['SessionToken']
    )
    client = boto3.client('organizations', **credentials)

    client.move_account(
        AccountId= ...,
        SourceParentId= ...,
        DestinationParentId=...
    )
```

#### <img src="https://avatars.githubusercontent.com/u/95037350?u=3cc857e639d4d38227d0bcb220cd7e9e104e4b99&v=4" width="50">[bgauchon-reply](https://github.com/bgauchon-reply) commented at [2022-01-06 13:54](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1006609355):

The permissions where added to automation account default eventbus to allow message from all organisation:
```
{
  "Version": "2012-10-17",
  "Statement": [{
    "Sid": "allow_all_accounts_from_organization_to_put_events",
    "Effect": "Allow",
    "Principal": "*",
    "Action": "events:PutEvents",
    "Resource": "arn:aws:events:eu-west-1:792281704736:event-bus/default",
    "Condition": {
      "StringEquals": {
        "aws:PrincipalOrgID": "o-l8ht390sac"
      }
    }
  }, {
    "Sid": "allow_account_to_manage_rules_they_created",
    "Effect": "Allow",
    "Principal": {
      "AWS": "arn:aws:iam::792281704736:root"
    },
    "Action": ["events:PutRule", "events:PutTargets", "events:DeleteRule", "events:RemoveTargets", "events:DisableRule", "events:EnableRule", "events:TagResource", "events:UntagResource", "events:DescribeRule", "events:ListTargetsByRule", "events:ListTagsForResource"],
    "Resource": "arn:aws:events:eu-west-1:792281704736:rule/default",
    "Condition": {
      "StringEqualsIfExists": {
        "events:creatorAccount": "${aws:userid}"
      }
    }
  }]
}
```

#### <img src="https://avatars.githubusercontent.com/u/95037350?u=3cc857e639d4d38227d0bcb220cd7e9e104e4b99&v=4" width="50">[bgauchon-reply](https://github.com/bgauchon-reply) commented at [2022-01-06 13:57](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1006611147):

Log group created arn : "arn:aws:logs:eu-west-1:792281704736:log-group:/aws/events/aws-organizations-events:*"

#### <img src="https://avatars.githubusercontent.com/u/95037350?u=3cc857e639d4d38227d0bcb220cd7e9e104e4b99&v=4" width="50">[bgauchon-reply](https://github.com/bgauchon-reply) commented at [2022-01-06 14:01](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1006614105):

Event rule "arn:aws:events:eu-west-1:792281704736:event-bus/default" created in automation account

Manual testing failed. After inspection we forgot cloudtrail org events can be captured in ControlTower master account in region us-east-1 only.

- [x] Setup eventbridge rule on master account in us-east-1
- [x] Tests

#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) commented at [2022-02-21 09:55](https://github.com/reply-fr/sustainable-personal-accounts/issues/4#issuecomment-1046679439):

completed as per #18  - would need to create a workbook about manual setup of the automation account


-------------------------------------------------------------------------------



[Export of Github issue for [reply-fr/sustainable-personal-accounts](https://github.com/reply-fr/sustainable-personal-accounts).]
