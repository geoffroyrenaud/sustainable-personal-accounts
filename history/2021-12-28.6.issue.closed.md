# [\#6 Issue](https://github.com/reply-fr/sustainable-personal-accounts/issues/6) `closed`: Deploy lambda functions in Automation account

#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) opened issue at [2021-12-28 14:12](https://github.com/reply-fr/sustainable-personal-accounts/issues/6):

With this issue we develop and deploy all Lambda functions that are part of the SPA project. We do not include CodeBuild projects yet, and only want to control the overall flow of transitions across OU.

Pre-conditions:
- Issue #8 has been completed
- Issue #4 has been completed

Epic:

- [x] Write code for Lambda function `MoveVanillaAccount` in `/code/move_vanilla_account_lambda.py`. This function will receive an event generated by AWS Organizations, ensure that the OU is the one for Vanilla Accounts, extract the account id from the event itself, and move the account to the OU Assigned Accounts. Identifiers will be provided to the function as environment variables `VANILLA_ACCOUNTS_OU_IDENTIFIER` and `ASSIGNED_ACCOUNTS_OU_IDENTIFIER`.

- [x] Extend python script `deploy_resources.py` to automate the deployment of Lambda function `MoveVanillaAccount`. You should create a specific python construct for that purpose, with two parameters `vanilla_accounts_ou_identifier` and `assigned_accounts_ou_identifier`.

- [x] Test the deployment by moving one AWS account to the OU Vanilla Accounts. Ensure that execution of `MoveVanillaAccount` is reported in CloudWatch logs, and that the account is moved automatically to the OU Assigned Accounts.

- [x] Write code for Lambda function `SignalAssignedAccount` in `/code/signal_assigned_account_lambda.py`. This function will receive an event generated by AWS Organizations, ensure that the OU is the one for Assigned Accounts, and put an event `PreparedAccount` on the event bus. Identifier will be provided to the function as environment variable `ASSIGNED_ACCOUNTS_OU_IDENTIFIER`. Note that code is not complete here, since we do not create nor start a CodeBuild project yet.

- [x] Extend python script `deploy_resources.py` to automate the deployment of Lambda function `SignalAssignedAccount`. You should create a specific python construct for that purpose, with one parameters `assigned_accounts_ou_identifier`.

- [x] Write code for Lambda function `MoveAssignedAccount` in `/code/move_assigned_account_lambda.py`. This function will receive an event `PreparedAccount`, extract the account id from the event itself, and move the account from the OU Assigned Accounts to the OU Released Accounts. Identifiers will be provided to the function as environment variables `ASSIGNED_ACCOUNTS_OU_IDENTIFIER` and `RELEASED_ACCOUNTS_OU_IDENTIFIER`.

- [x] Extend python script `deploy_resources.py` to automate the deployment of Lambda function `MoveAssignedAccount`. You should create a specific python construct for that purpose, with two parameters `assigned_accounts_ou_identifier` and `released_accounts_ou_identifier`.

- [x] Test the deployment by moving one AWS account to the OU Vanilla Accounts. Ensure that execution of `MoveVanillaAccount`, of `SignalAssignedAccount`, and of `MoveAssignedAccount` are reported in CloudWatch logs, and that the account is moved automatically to the OU Released Accounts.

- [x] Write code for Lambda function `SignalExpiredAccount` in `/code/signal_expired_account_lambda.py`. This function will receive an event generated by AWS Organizations, ensure that the OU is the one for Expired Accounts, and put an event `PurgedAccount` on the event bus. Identifier will be provided to the function as environment variable `EXPIRED_ACCOUNTS_OU_IDENTIFIER`. Note that code is not complete here, since we do not create nor start a CodeBuild project yet.

- [x] Extend python script `deploy_resources.py` to automate the deployment of Lambda function `SignalExpiredAccount`. You should create a specific python construct for that purpose, with one parameters `expired_accounts_ou_identifier`.

- [x] Write code for Lambda function `MoveExpiredAccount` in `/code/move_expired_account_lambda.py`. This function will receive an event `PurgedAccount`, extract the account id from the event itself, and move the account from the OU Expired Accounts to the OU Assigned Accounts. Identifiers will be provided to the function as environment variables `EXPIRED_ACCOUNTS_OU_IDENTIFIER` and `ASSIGNED_ACCOUNTS_OU_IDENTIFIER`.

- [x] Extend python script `deploy_resources.py` to automate the deployment of Lambda function `MoveExpiredAccount`. You should create a specific python construct for that purpose, with two parameters `expired_accounts_ou_identifier` and `assigned_accounts_ou_identifier`.

- [x] Test the deployment by moving one AWS account to the OU Expired Accounts. Ensure that execution of `SignalExpiredAccount`, of `MoveExpiredAccount`, of `SignalAssignedAccount` and of `MoveAssignedAccount` are reported in CloudWatch logs, and that the account is moved automatically to the OU Released Accounts.




#### <img src="https://avatars.githubusercontent.com/u/235078?v=4" width="50">[bernard357](https://github.com/bernard357) commented at [2022-02-21 09:52](https://github.com/reply-fr/sustainable-personal-accounts/issues/6#issuecomment-1046676596):

completed by #18


-------------------------------------------------------------------------------



[Export of Github issue for [reply-fr/sustainable-personal-accounts](https://github.com/reply-fr/sustainable-personal-accounts).]
