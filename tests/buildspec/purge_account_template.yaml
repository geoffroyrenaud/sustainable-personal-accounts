version: 0.2

env:
  variables:
    PURGE_EMAIL: a@b.com

phases:
  install:
    commands:
      - wget -q https://github.com/rebuy-de/aws-nuke/releases/download/v2.17.0/aws-nuke-v2.17.0-linux-arm64.tar.gz
      - tar -xvf aws-nuke-v2.17.0-linux-arm64.tar.gz
      - mv aws-nuke-v2.17.0-linux-arm64 /bin/aws-nuke
      - chmod +x /bin/aws-nuke
  build:
    commands:
      - echo "Account purge started on $(date)"
      - ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
      - |
        cat <<EOF > aws-nuke-config.yaml
        regions:
          - global
          - eu-west-1
          - eu-west-3
          - us-east-1
        account-blocklist:
          - "999999999999" # production
        resource-types: # only nuke these resources
          targets:
          - CloudFormationStack
          - CloudFrontDistribution
          - CloudFrontDistributionDeployment
          - CloudFrontOriginAccessIdentity
          # - CloudSearchDomain
          # - CloudWatchLogsDestination
          # - CloudWatchLogsLogGroup
          # - CloudWatchLogsResourcePolicy
          # - CodeArtifactDomain
          # - CodeArtifactRepository
          # - CodeBuildProject
          # - CodeCommitRepository
          # - CodeDeployApplication
          # - CodePipelinePipeline
          # - CodeStarConnection
          # - CodeStarNotificationRule
          # - CodeStarProject
          # - CognitoIdentityPool
          # - CognitoIdentityProvider
          # - CognitoUserPool
          # - CognitoUserPoolClient
          # - CognitoUserPoolDomain
          # - DAXCluster
          # - DAXParameterGroup
          # - DAXSubnetGroup
          # - DataPipelinePipeline
          # - DeviceFarmProject
          # - DirectoryServiceDirectory
          # - DynamoDBTable
          # - DynamoDBTableItem
          - EC2Address
          - EC2ClientVpnEndpoint
          - EC2CustomerGateway
          - EC2Image
          - EC2Instance
          - EC2InternetGateway
          - EC2InternetGatewayAttachment
          - EC2KeyPair
          - EC2NATGateway
          - EC2NetworkACL
          - EC2NetworkInterface
          - EC2PlacementGroup
          - EC2RouteTable
          - EC2SecurityGroup
          - EC2Snapshot
          - EC2SpotFleetRequest
          - EC2TGW
          - EC2VPC
          - EC2VPCEndpoint
          - EC2VPNConnection
          - EC2VPNGateway
          - EC2Volume
          # - ECRRepository
          - ECSCluster
          - ECSClusterInstance
          - ECSService
          - ECSTaskDefinition
          - EFSFileSystem
          - EFSMountTarget
          - EKSCluster
          - EKSNodegroups
          - ELB
          - ELBv2
          - EMRCluster
          # - ESDomain
          # - ElasticBeanstalkApplication
          # - ElasticacheCacheCluster
          # - FSxBackup
          - FSxFileSystem
          # - GlueDatabase
          # - GlueDevEndpoint
          - IAMGroup
          # - IAMGroupPolicy
          # - IAMGroupPolicyAttachment
          # - IAMOpenIDConnectProvider
          # - IAMPolicy
          # - IAMRole
          # - IAMRolePolicy
          - IAMUser
          - IAMUserAccessKey
          # - IAMUserPolicy
          # - ImageBuilderImage
          # - ImageBuilderPipeline
          # - LambdaFunction
          # - LambdaLayer
          # - MQBroker
          # - MSKCluster
          # - NeptuneCluster
          # - NeptuneInstance
          # - NetpuneSnapshot
          # - RDSDBCluster
          # - RDSInstance
          # - RDSProxy
          # - RDSSnapshot
          # - RedshiftCluster
          # - RedshiftSnapshot
          # - RekognitionCollection
          # - Route53HostedZone
          # - S3AccessPoint
          - S3Bucket
          # - SNSTopic
          # - SQSQueue
          # - SSMAssociation
          # - SSMDocument
          # - SSMParameter
          # - SageMakerNotebookInstance
          # - SecretsManagerSecret
          # - WorkSpacesWorkspace
        accounts:
          "${ACCOUNT}": {}
        EOF
      - echo "Setting an automated alias for this account"
      - ALIAS=$(cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 25 | head -n 1)
      - aws iam create-account-alias --account-alias $ALIAS
      - echo "Running AWS-Nuke on account $ACCOUNT"
      - aws-nuke -c aws-nuke-config.yaml --force | tee -a aws-nuke.log
      - echo "Account purge completed on $(date)"
